<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: admin/core/class-admin-navmenu.php - Ultimate Member Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-um.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: admin/core/class-admin-navmenu.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
namespace um\admin\core;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) exit;

if ( ! class_exists( 'um\admin\core\Admin_Navmenu' ) ) {


	/**
	 * Class Admin_Navmenu
	 * @package um\admin\core
	 */
	class Admin_Navmenu {
		/**
		 * @var array
		 */
		protected static $fields = array();


		/**
		 * Admin_Navmenu constructor.
		 */
		function __construct() {
			global $wp_version;

			self::$fields = array(
				'um_nav_public' => __( 'Display Mode', 'ultimate-member' ),
				'um_nav_roles'  => __( 'By Role', 'ultimate-member' )
			);

			if ( $wp_version &lt; '5.4' ) {
				add_action( 'admin_footer-nav-menus.php', array( &amp;$this, '_wp_template' ) );
				add_action( 'load-nav-menus.php', array( &amp;$this, 'enqueue_nav_menus_scripts' ) );
			} else {
				add_action( 'load-customize.php', array( &amp;$this, 'enqueue_nav_menus_scripts' ) );
			}

			add_action( 'wp_update_nav_menu_item', array( &amp;$this, '_save' ), 10, 3 );

			add_action( 'wp_nav_menu_item_custom_fields', array( $this, 'wp_nav_menu_item_custom_fields' ), 20, 5 );
			//add_action( 'wp_nav_menu_item_custom_fields_customize_template', array( $this, 'wp_nav_menu_item_custom_fields_customize_template' ), 20 ); //waiting wp.org answer
		}


		/**
		 * Fires just before the move buttons of a nav menu item in the menu editor.
		 * Adds block "Ultimate Member Menu Settings"
		 *
		 * @since WP 5.4.0
		 * @hook  wp_nav_menu_item_custom_fields
		 *
		 * @param int      $item_id Menu item ID.
		 * @param \WP_Post  $item    Menu item data object.
		 * @param int      $depth   Depth of menu item. Used for padding.
		 * @param \stdClass $args    An object of menu item arguments.
		 * @param int      $id      Nav menu ID.
		 */
		function wp_nav_menu_item_custom_fields( $item_id, $item, $depth, $args, $id = null ) {

			$um_nav_public = get_post_meta( $item->ID, 'menu-item-um_nav_public', true );
			$_nav_roles_meta = get_post_meta( $item->ID, 'menu-item-um_nav_roles', true );
			$um_nav_roles = array();
			if ( $_nav_roles_meta ) {
				foreach ( $_nav_roles_meta as $key => $value ) {
					if ( is_int( $key ) ) {
						$um_nav_roles[] = $value;
					}
				}
			}
			$options = UM()->roles()->get_roles( false );
			?>
			&lt;div class="um-nav-edit">
				&lt;div class="clear">&lt;/div>
				&lt;h4 style="margin-bottom: 0.6em;">&lt;?php _e( 'Ultimate Member Menu Settings', 'ultimate-member' ) ?>&lt;/h4>

				&lt;p class="description description-wide um-nav-mode">
					&lt;label for="edit-menu-item-um_nav_public-&lt;?php echo esc_attr( $item_id ); ?>">
						&lt;?php _e( "Who can see this menu link?", 'ultimate-member' ); ?>&lt;br/>
						&lt;select id="edit-menu-item-um_nav_public-&lt;?php echo esc_attr( $item_id ); ?>" name="menu-item-um_nav_public[&lt;?php echo esc_attr( $item_id ); ?>]" style="width:100%;">
							&lt;option value="0" &lt;?php selected( $um_nav_public, 0 ); ?>>&lt;?php _e( 'Everyone', 'ultimate-member' ) ?>&lt;/option>
							&lt;option value="1" &lt;?php selected( $um_nav_public, 1 ); ?>>&lt;?php _e( 'Logged Out Users', 'ultimate-member' ) ?>&lt;/option>
							&lt;option value="2" &lt;?php selected( $um_nav_public, 2 ); ?>>&lt;?php _e( 'Logged In Users', 'ultimate-member' ) ?>&lt;/option>
						&lt;/select>
					&lt;/label>
				&lt;/p>

				&lt;p class="description description-wide um-nav-roles" &lt;?php echo $um_nav_public == 2 ? 'style="display: block;"' : ''; ?>>&lt;?php _e( "Select the member roles that can see this link", 'ultimate-member' ) ?>&lt;br>

					&lt;?php
					$i = 0;
					$html = '';
					$columns = apply_filters( 'wp_nav_menu_item:um_nav_columns', 2, $item_id, $item );
					$per_page = ceil( count( $options ) / $columns );
					while ( $i &lt; $columns ) {
						$section_fields_per_page = array_slice( $options, $i * $per_page, $per_page );
						$html .= '&lt;span class="um-form-fields-section" style="width:' . floor( 100 / $columns ) . '% !important;">';

						foreach ( $section_fields_per_page as $k => $title ) {
							$id_attr = ' id="edit-menu-item-um_nav_roles-' . $item_id . '_' . $k . '" ';
							$for_attr = ' for="edit-menu-item-um_nav_roles-' . $item_id . '_' . $k . '" ';
							$checked_attr = checked( in_array($k,$um_nav_roles), true, false );
							$html .= "&lt;label {$for_attr}> &lt;input type='checkbox' {$id_attr} name='menu-item-um_nav_roles[{$item_id}][{$k}]' value='1' {$checked_attr} /> &lt;span>{$title}&lt;/span> &lt;/label>";
						}

						$html .= '&lt;/span>';
						$i++;
					}
					echo $html;
					?>
				&lt;/p>
				&lt;div class="clear">&lt;/div>
			&lt;/div>
			&lt;?php
		}


		/**
		 *
		 */
		function wp_nav_menu_item_custom_fields_customize_template() {
			?>
			&lt;div class="um-nav-edit">
				&lt;div class="clear">&lt;/div>
				&lt;h4 style="margin-bottom: 0.6em;">&lt;?php _e( 'Ultimate Member Menu Settings', 'ultimate-member' ) ?>&lt;/h4>

				&lt;# console.log( data ); #>

				&lt;div class="clear">&lt;/div>
			&lt;/div>
			&lt;?php
		}








		/**
		 *
		 * Backward compatibility with WP &lt; 5.4
		 *
		 */


		/**
		 * @param int $menu_id
		 * @param int $menu_item_db_id
		 * @param array $menu_item_args
		 */
		function _save( $menu_id, $menu_item_db_id, $menu_item_args ) {
			if ( defined( 'DOING_AJAX' ) &amp;&amp; DOING_AJAX ) {
				return;
			}

			if ( empty( $_POST['menu-item-db-id'] ) || ! in_array( $menu_item_db_id, $_POST['menu-item-db-id'] ) ) {
				return;
			}

			foreach ( self::$fields as $_key => $label ) {

				$key = sprintf( 'menu-item-%s', $_key );

				// Sanitize
				if ( ! empty( $_POST[ $key ][ $menu_item_db_id ] ) ) {
					// Do some checks here...
					$value = is_array( $_POST[ $key ][ $menu_item_db_id ] ) ?
						array_map( 'sanitize_key', array_keys( $_POST[ $key ][ $menu_item_db_id ] ) ) : (int) $_POST[ $key ][ $menu_item_db_id ];
				} else {
					$value = null;
				}

				// Update
				if ( ! is_null( $value ) ) {
					update_post_meta( $menu_item_db_id, $key, $value );
				} else {
					delete_post_meta( $menu_item_db_id, $key );
				}
			}
		}


		/**
		 *
		 */
		function enqueue_nav_menus_scripts() {
			add_action( 'admin_enqueue_scripts', array( &amp;$this, 'admin_enqueue_scripts' ) );
		}


		/**
		 *
		 */
		function admin_enqueue_scripts() {
			UM()->admin_enqueue()->load_nav_manus_scripts();

			$menu_restriction_data = array();

			$menus = get_posts( 'post_type=nav_menu_item&amp;numberposts=-1' );
			foreach ( $menus as $data ) {
				$_nav_roles_meta = get_post_meta( $data->ID, 'menu-item-um_nav_roles', true );

				$um_nav_roles = array();
				if ( $_nav_roles_meta ) {
					foreach ( $_nav_roles_meta as $key => $value ) {
						if ( is_int( $key ) ) {
							$um_nav_roles[] = $value;
						}
					}
				}

				$menu_restriction_data[ $data->ID ] = array(
					'um_nav_public' => get_post_meta( $data->ID, 'menu-item-um_nav_public', true ),
					'um_nav_roles'  => $um_nav_roles,
				);
			}

			wp_localize_script( 'um_admin_nav_manus', 'um_menu_restriction_data', $menu_restriction_data );
		}


		/**
		 *
		 */
		function _wp_template() {
			?>
			&lt;script type="text/html" id="tmpl-um-nav-menus-fields">
				&lt;div class="um-nav-edit">

					&lt;div class="clear">&lt;/div>

					&lt;h4 style="margin-bottom: 0.6em;">&lt;?php _e( "Ultimate Member Menu Settings", 'ultimate-member' ) ?>&lt;/h4>

					&lt;p class="description description-wide um-nav-mode">
						&lt;label for="edit-menu-item-um_nav_public-{{data.menuItemID}}">
							&lt;?php _e( "Who can see this menu link?", 'ultimate-member' ); ?>&lt;br/>
							&lt;select id="edit-menu-item-um_nav_public-{{data.menuItemID}}"
							        name="menu-item-um_nav_public[{{data.menuItemID}}]" style="width:100%;">
								&lt;option value="0" &lt;# if( data.restriction_data.um_nav_public == '0' ){ #>selected="selected"&lt;# } #>>
								&lt;?php _e( 'Everyone', 'ultimate-member' ) ?>
								&lt;/option>
								&lt;option value="1" &lt;# if( data.restriction_data.um_nav_public == '1' ){ #>selected="selected"&lt;# } #>>
								&lt;?php _e( 'Logged Out Users', 'ultimate-member' ) ?>
								&lt;/option>
								&lt;option value="2" &lt;# if( data.restriction_data.um_nav_public == '2' ){ #>selected="selected"&lt;# } #>>
								&lt;?php _e( 'Logged In Users', 'ultimate-member' ) ?>
								&lt;/option>
							&lt;/select>
						&lt;/label>
					&lt;/p>
					&lt;p class="description description-wide um-nav-roles" &lt;# if( data.restriction_data.um_nav_public == '2' ){ #>style="display: block;"&lt;# } #>>
					&lt;?php _e( "Select the member roles that can see this link", 'ultimate-member' ) ?>&lt;br/>

					&lt;?php $options = UM()->roles()->get_roles( false );
					$i = 0;
					$html = '';
					$columns = 2;
					while ( $i &lt; $columns ) {
						$per_page = ceil( count( $options ) / $columns );
						$section_fields_per_page = array_slice( $options, $i * $per_page, $per_page );
						$html .= '&lt;span class="um-form-fields-section" style="width:' . floor( 100 / $columns ) . '% !important;">';

						foreach ( $section_fields_per_page as $k => $title ) {
							$id_attr = ' id="edit-menu-item-um_nav_roles-{{data.menuItemID}}_' . $k . '" ';
							$for_attr = ' for="edit-menu-item-um_nav_roles-{{data.menuItemID}}_' . $k . '" ';
							$html .= "&lt;label $for_attr>
		                            &lt;input type='checkbox' {$id_attr} name='menu-item-um_nav_roles[{{data.menuItemID}}][{$k}]' value='1' &lt;# if( _.contains( data.restriction_data.um_nav_roles,'{$k}' ) ){ #>checked='checked'&lt;# } #> />
		                            &lt;span>{$title}&lt;/span>
		                        &lt;/label>";
						}

						$html .= '&lt;/span>';
						$i++;
					}

					echo $html; ?>
					&lt;/p>

					&lt;div class="clear">&lt;/div>
				&lt;/div>
			&lt;/script>
			&lt;?php
		}
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://wordpress.org/plugins/ultimate-member/">Ultimate Member Plugin</a> &bull;
		<a href="https://docs.ultimatemember.com/">Official Docs</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="template_redirect.html">template_redirect</a></li><li><a href="um_after_delete_role.html">um_after_delete_role</a></li><li><a href="um_after_delete_role_meta.html">um_after_delete_role_meta</a></li><li><a href="um_role_edit_data.html">um_role_edit_data</a></li><li><a href="um_role_row_actions.html">um_role_row_actions</a></li><li><a href="wp_nav_menu_item_custom_fields.html">wp_nav_menu_item_custom_fields</a></li></ul><h3>Filters</h3><ul><li><a href="icl_ls_languages.html">icl_ls_languages</a></li><li><a href="um_disable_blocks_script.html">um_disable_blocks_script</a></li><li><a href="um_disable_email_notification_sending.html">um_disable_email_notification_sending</a></li><li><a href="um_email_get_template_file_path.html">um_email_get_template_file_path</a></li><li><a href="um_external_profile_url.html">um_external_profile_url</a></li><li><a href="um_get_current_page_url.html">um_get_current_page_url</a></li><li><a href="um_late_escaping_allowed_tags.html">um_late_escaping_allowed_tags</a></li><li><a href="um_localize_permalink_filter.html">um_localize_permalink_filter</a></li><li><a href="um_override_templates_get_template_path__%257B$key%257D.html">um_override_templates_get_template_path__{$key}</a></li><li><a href="um_override_templates_scan_files.html">um_override_templates_scan_files</a></li><li><a href="um_pre_args_setup.html">um_pre_args_setup</a></li><li><a href="um_profile_permalink.html">um_profile_permalink</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
